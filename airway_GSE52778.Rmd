---
title: "airway_GSE52778"
author: "Mikias HW"
date: "`r Sys.Date()`"
output: 
  prettydoc::html_pretty:
    theme: hpstr
    df_print: paged
---

# Load Libraries 
```{r include=FALSE}
suppressPackageStartupMessages(library("GEOquery"))
suppressPackageStartupMessages(library("airway"))
library(DESeq2)
library(iSEE)
library(iSEEde)
library("org.Hs.eg.db")
library("scater")
library("scuttle")
library(gridExtra)
```

# Geo access
```{r eval=FALSE, include=FALSE}
dir <- system.file("extdata",package="airway")

geofile <- file.path(dir, "GSE52778_series_matrix.txt")

gse <- getGEO(filename=geofile)

pdata <- pData(gse)[,grepl("ch1",names(pData(gse)))]

names(pdata) <- c("treatment","tissue","ercc_mix","cell","celltype")

pdataclean <- data.frame(treatment=sub("treatment: (.*)","\\1",pdata$treatment),
                         cell=sub("cell line: (.*)","\\1",pdata$cell),
                         row.names=rownames(pdata))

pdataclean$dex <- ifelse(grepl("Dex",pdataclean$treatment),"trt","untrt")

pdataclean$albut <- ifelse(grepl("Albut",pdataclean$treatment),"trt","untrt")

pdataclean$SampleName <- rownames(pdataclean)

pdataclean$treatment <- NULL


srafile <- file.path(dir, "SraRunInfo_SRP033351.csv")

srp <- read.csv(srafile)

srpsmall <- srp[,c("Run","avgLength","Experiment","Sample","BioSample","SampleName")]


coldata <- merge(pdataclean, srpsmall, by="SampleName")

rownames(coldata) <- coldata$Run

coldata <- coldata[coldata$albut == "untrt",]

coldata$albut <- NULL

coldata

write.csv(coldata, file="sample_table.csv")

```

# RangedSummarizedExperiment
```{r include=FALSE}
data(airway)

airway

se <- airway

se

#extract counts
counts <- as.data.frame(assays(se)$counts)

#extract metadata
colData <- as.data.frame(colData(se))

#Count stats
summary(colSums(assay(se)) / 1e6)

#Introduction
metadata(se)

#Title
se@metadata[[1]]@title

#Abstract
se@metadata[[1]]@abstract

#Sample names
se@colData@rownames

#Sum of sampes
length(se@colData@rownames)

#Sum of genes
length(assays(se)$counts)

#Genome information
metadata(rowRanges(se))

dds <- DESeqDataSet(se, design = ~ cell + dex)

dds
```

# Background

## Title 
```{r echo=FALSE}
se@metadata[[1]]@title
```

## Experiment information 
```{r echo=FALSE}
metadata(se)
```

## Abstract
    `r se@metadata[[1]]@abstract`
```{r echo=FALSE}
se@metadata[[1]]@abstract
```

## Samples
```{r echo=FALSE}
se@colData@rownames
```

## Number of samples: `r length(se@colData@rownames)`
```{r echo=FALSE}
as.data.frame(colData(se))
```

## Number of Genes: `r length(assays(se)$counts)`
```{r echo=FALSE}
head(as.data.frame(assays(se)$counts))
```

## Genome Information
```{r echo=FALSE}
metadata(rowRanges(se))
```


# Define MA plotting function
```{r}
# MA Plots
# Arranged into 2 rows
# Color & translucency by DEG
# Plot titles fed in as arguments
# Mean counts (x-axis) Log10 transformed

plotMA_arrange_iterative <- function(res_list) {
  plots <- list()

  for (i in seq_along(res_list)) {
    result <- res_list[[i]]
    res_name <- names(res_list)[i] # Get the name of the res object
    res_sum <- sum(result$padj < 0.05, na.rm=TRUE)
    p <- plotMA(result, returnData = TRUE) # DESeq2's PlotMA function
    p_plot <- ggplot(p, aes(x = mean, y = lfc, color = isDE)) +
      geom_point(aes(alpha = ifelse(isDE == "TRUE", 1, 0.1)), show.legend = FALSE) + # Reduce non DEG genes transperancy
      scale_x_continuous(trans = "log10") + # Scale mean counts
      ylim(-2, 2) +
      labs(title = res_name, 
           subtitle = (gsub(".*\\(MAP\\):\\s*", "",
                            result@elementMetadata@listData[["description"]][2])), 
           caption = paste("Total genes:", res_sum)) # Label plots

    plots[[i]] <- p_plot
  }

  do.call(grid.arrange, c(plots, nrow = 3))
}
```


# Dex variable only
```{r}
#Ensure matching sample names & order
all(colnames(counts) %in% row.names(colData))

all(colnames(counts) == row.names(colData))

# Define design matrix for DESeq2
dds1 <- DESeqDataSetFromMatrix(
  countData = counts,
  colData = colData,
  design = ~ dex
)

# normalization by estimating size factor
dds1 <- estimateSizeFactors(dds1)

# remove low expressed genes
keep <- rowSums(counts(dds1)) >= 10

dds1 <- dds1[keep, ]

# set factor level (reference group)
dds1$dex <- relevel(dds1$dex, ref = "untrt")

# Run DEG analysis
dds1 <- DESeq(dds1)

res1 <- results(dds1)

res1

resultsNames(dds1)

resSum1 <- sum(res1$padj < 0.05, na.rm=TRUE)

# Log fold shrink
resLFC1 <- lfcShrink(dds1, coef = "dex_trt_vs_untrt", type="apeglm")

# xlim <- c(1,1e5); ylim <- c(-3,3)
# 
# plotMA(resLFC1, xlim=xlim, ylim=ylim, main="apeglm")
```

# Cell variable only
```{r}
# Define design matrix for DESeq2
dds0 <- DESeqDataSetFromMatrix(
  countData = counts,
  colData = colData,
  design = ~ cell)

# normalization by estimating size factor
dds0 <- estimateSizeFactors(dds0)

# remove low expressed genes
keep <- rowSums(counts(dds0)) >= 10

dds0 <- dds0[keep, ]

# set factor level (reference group)
dds0$cell <- relevel(dds0$cell, ref = "N61311")

# Run DEG analysis
dds0 <- DESeq(dds0)

resultsNames(dds0)

# Extract results & Log fold shrink
res0 <- results(dds0, contrast = c("cell", "N052611", "N61311"))
resLFC0 <- lfcShrink(dds0, coef = "cell_N052611_vs_N61311", type="apeglm")

res0a <- results(dds0, contrast = c("cell", "N061011", "N61311"))
resLFC0a <- lfcShrink(dds0, coef = "cell_N061011_vs_N61311", type="apeglm")

res0b <- results(dds0, contrast = c("cell", "N080611", "N61311"))
resLFC0b <- lfcShrink(dds0, coef = "cell_N080611_vs_N61311", type="apeglm")
```

# Dex & Cell variables
```{r}
# Define design matrix for DESeq2
dds2 <- DESeqDataSetFromMatrix(
  countData = counts,
  colData = colData,
  design = ~ dex + cell)

# normalization by estimating size factor
dds2 <- estimateSizeFactors(dds2)

# remove low expressed genes
keep <- rowSums(counts(dds2)) >= 10
dds2 <- dds2[keep, ]

# set factor level (reference group)
dds2$dex <- relevel(dds2$dex, ref = "untrt")
dds2$cell <- relevel(dds2$cell, ref = "N61311")

# Run DEG analysis
dds2 <- DESeq(dds2)

resultsNames(dds2)

# Extract results & Log fold shrink
res2 <- results(dds2, contrast = c("dex", "trt", "untrt"))
resLFC2 <- lfcShrink(dds2, coef = "dex_trt_vs_untrt", type="apeglm")

res2a <- results(dds2, contrast = c("cell", "N052611", "N61311"))
resLFC2a <- lfcShrink(dds2, coef = "cell_N052611_vs_N61311", type="apeglm")

res2b <- results(dds2, contrast = c("cell", "N061011", "N61311"))
resLFC2b <- lfcShrink(dds2, coef = "cell_N061011_vs_N61311", type="apeglm")

res2c <- results(dds2, contrast = c("cell", "N080611", "N61311"))
resLFC2c <- lfcShrink(dds2, coef = "cell_N080611_vs_N61311", type="apeglm")
```

# Dex & Cell Interaction : **Not possible in this case**
```{r}
# Define design matrix for DESeq2
dds3 <- DESeqDataSetFromMatrix(
  countData = counts,
  colData = colData,
  design = ~ dex + cell + dex:cell)

# normalization by estimating size factor
dds3 <- estimateSizeFactors(dds3)

# remove low expressed genes
keep <- rowSums(counts(dds3)) >= 10
dds3 <- dds3[keep, ]

# set factor level (reference group)
dds3$dex <- relevel(dds3$dex, ref = "untrt")
dds3$cell <- relevel(dds3$cell, ref = "N61311")

# Run DEG analysis
# dds3 <- DESeq(dds3)
```

running `DESeq(dds3)` returns the following
    
    Error in checkForExperimentalReplicates(object, modelMatrix) :

    The design matrix has the same number of samples and coefficients to fit,so estimation of dispersion is not possible. Treating samples as replicates was deprecated in v1.20 and no longer supported since v1.22.

# Visualize All Contrasts
```{r}
res_list <- list(
  "~ dex" = resLFC1,
  "~ cell" = resLFC0,
  "~ cell" = resLFC0a,
  "~ cell" = resLFC0b,
  "~ dex + cell" = resLFC2,
  "~ dex + cell" = resLFC2a,
  "~ dex + cell" = resLFC2b,
  "~ dex + cell" = resLFC2c
)

plotMA_arrange_iterative(res_list)
```



Factors
```{r}
# dds$condition <- relevel(dds$condition, ref = "untreated")
```

