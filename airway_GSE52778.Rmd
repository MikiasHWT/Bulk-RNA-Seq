---
title: "airway_GSE52778"
author: "Mikias HW"
date: "`r Sys.Date()`"
output: 
  prettydoc::html_pretty:
    theme: hpstr
    df_print: paged
---

# Load Libraries 
```{r results='hide', message=FALSE, warning=FALSE}
library(GEOquery)
library(airway)
library(DESeq2)
library(iSEE)
library(iSEEde)
library(org.Hs.eg.db)
library(scater)
library(scuttle)
library(gridExtra)
library(qvalue)
library(vsn) 
library(apeglm) 
library(ashr) 
library(pheatmap) 
library(RColorBrewer) 
library(EnhancedVolcano) 
library(gridExtra)
```

# RangedSummarizedExperiment
```{r}
#load airway dataset as rse object
data(airway)

rse <- airway

rse

#extract counts
counts <- as.data.frame(assays(rse)$counts)

#extract metadata
colData <- as.data.frame(colData(rse))
```

# Background

## Title 
```{r echo=FALSE}
rse@metadata[[1]]@title
```

## Experiment information 
```{r echo=FALSE}
metadata(rse)
```

## Abstract
    `r rse@metadata[[1]]@abstract`
```{r echo=FALSE}
rse@metadata[[1]]@abstract
```

## Samples
```{r echo=FALSE}
rse@colData@rownames
```

## Number of samples: `r length(rse@colData@rownames)`
```{r echo=FALSE}
as.data.frame(colData(rse))
```

## Number of Genes: `r length(assays(rse)$counts)`
```{r echo=FALSE}
head(as.data.frame(assays(rse)$counts))
```

## Genome Information
```{r echo=FALSE}
metadata(rowRanges(rse))
```


# Define MA plotting function
```{r}
# MA Plots
# Arranged into 2 rows
# Color & translucency by DEG
# Plot titles fed in as arguments
# Mean counts (x-axis) Log10 transformed

plotMA_arrange_iterative <- function(res_list) {
  plots <- list()

  for (i in seq_along(res_list)) {
    result <- res_list[[i]]
    res_name <- names(res_list)[i] # Get the name of the resDxC1 object
    res_sum <- sum(result$padj < 0.05, na.rm=TRUE) # Get sum of DEG's
    p <- plotMA(result, returnData = TRUE) # DESeq2's PlotMA function
    p_plot <- ggplot(p, aes(x = mean, y = lfc, color = isDE)) +
      geom_point(aes(alpha = ifelse(isDE == "TRUE", 1, 0.1)), show.legend = FALSE) + # Reduce non-DEG transperancy
      scale_x_continuous(trans = "log10") + # Scale mean counts
      ylim(-2, 2) +   
      labs(title = res_name, 
           subtitle = (gsub(".*\\(MAP\\):\\s*", "",
                            result@elementMetadata@listData[["description"]][2])), # workaround to label plots with resDxC1 contrasts
           caption = paste("Total genes:", res_sum))

    plots[[i]] <- p_plot
  }

  do.call(grid.arrange, c(plots, nrow = 3))
}
```


# Dex variable only
```{r message=FALSE}
#Ensure matching sample names & order
all(colnames(counts) %in% row.names(colData))

all(colnames(counts) == row.names(colData))

# Define design matrix for DESeq2
ddsDex <- DESeqDataSetFromMatrix(
  countData = counts,
  colData = colData,
  design = ~ dex
)

# normalization by estimating size factor
ddsDex <- estimateSizeFactors(ddsDex)

# remove low expressed genes
keep <- rowSums(counts(ddsDex)) >= 10

ddsDex <- ddsDex[keep, ]

# set factor level (reference group)
ddsDex$dex <- relevel(ddsDex$dex, ref = "untrt")

# Run DEG analysis
ddsDex <- DESeq(ddsDex)

resDex <- results(ddsDex)

# Log fold shrink
resLFC1 <- lfcShrink(ddsDex, coef = "dex_trt_vs_untrt", type="apeglm")
```

# Cell variable only
```{r message=FALSE}
# Define design matrix for DESeq2
ddsCell <- DESeqDataSetFromMatrix(
  countData = counts,
  colData = colData,
  design = ~ cell)

# normalization by estimating size factor
ddsCell <- estimateSizeFactors(ddsCell)

# remove low expressed genes
keep <- rowSums(counts(ddsCell)) >= 10

ddsCell <- ddsCell[keep, ]

# set factor level (reference group)
ddsCell$cell <- relevel(ddsCell$cell, ref = "N61311")

# Run DEG analysis
ddsCell <- DESeq(ddsCell)

resultsNames(ddsCell)

# Extract results & Log fold shrink
resCell1 <- results(ddsCell, contrast = c("cell", "N052611", "N61311"))
resCellLFC1 <- lfcShrink(ddsCell, coef = "cell_N052611_vs_N61311", type="apeglm")

resCell2 <- results(ddsCell, contrast = c("cell", "N061011", "N61311"))
resCellLFC2 <- lfcShrink(ddsCell, coef = "cell_N061011_vs_N61311", type="apeglm")

resCell3 <- results(ddsCell, contrast = c("cell", "N080611", "N61311"))
resCellLFC3 <- lfcShrink(ddsCell, coef = "cell_N080611_vs_N61311", type="apeglm")
```

# Dex & Cell variables
```{r message=FALSE}
# Define design matrix for DESeq2
ddsDxC <- DESeqDataSetFromMatrix(
  countData = counts,
  colData = colData,
  design = ~ dex + cell)

# normalization by estimating size factor
ddsDxC <- estimateSizeFactors(ddsDxC)

# remove low expressed genes
keep <- rowSums(counts(ddsDxC)) >= 10
ddsDxC <- ddsDxC[keep, ]

# set factor level (reference group)
ddsDxC$dex <- relevel(ddsDxC$dex, ref = "untrt")
ddsDxC$cell <- relevel(ddsDxC$cell, ref = "N61311")

# Run DEG analysis
ddsDxC <- DESeq(ddsDxC)

resultsNames(ddsDxC)

# Extract results & Log fold shrink
resDxC1 <- results(ddsDxC, contrast = c("dex", "trt", "untrt"))
resDxCLFC1 <- lfcShrink(ddsDxC, coef = "dex_trt_vs_untrt", type="apeglm")

resDxC2 <- results(ddsDxC, contrast = c("cell", "N052611", "N61311"))
resDxCLFC2 <- lfcShrink(ddsDxC, coef = "cell_N052611_vs_N61311", type="apeglm")

resDxC3 <- results(ddsDxC, contrast = c("cell", "N061011", "N61311"))
resDxCLFC3 <- lfcShrink(ddsDxC, coef = "cell_N061011_vs_N61311", type="apeglm")

resDxC4 <- results(ddsDxC, contrast = c("cell", "N080611", "N61311"))
resDxCLFC4 <- lfcShrink(ddsDxC, coef = "cell_N080611_vs_N61311", type="apeglm")
```

# Dex & Cell Interaction : **Not possible in this case**
```{r}
# Define design matrix for DESeq2
dds3 <- DESeqDataSetFromMatrix(
  countData = counts,
  colData = colData,
  design = ~ dex + cell + dex:cell)

# normalization by estimating size factor
dds3 <- estimateSizeFactors(dds3)

# remove low expressed genes
keep <- rowSums(counts(dds3)) >= 10
dds3 <- dds3[keep, ]

# set factor level (reference group)
dds3$dex <- relevel(dds3$dex, ref = "untrt")
dds3$cell <- relevel(dds3$cell, ref = "N61311")

# Run DEG analysis
# dds3 <- DESeq(dds3)
```

running `DESeq(dds3)` returns the following
    
    Error in checkForExperimentalReplicates(object, modelMatrix) :

    The design matrix has the same number of samples and coefficients to fit,so estimation of dispersion is not possible. Treating samples as replicates was deprecated in v1.20 and no longer supported since v1.22.

# Visualize All Contrasts
```{r warning=FALSE}
res_list <- list(
  "~ dex" = resLFC1,
  "~ cell" = resCellLFC1,
  "~ cell" = resCellLFC2,
  "~ cell" = resCellLFC3,
  "~ dex + cell" = resDxCLFC1,
  "~ dex + cell" = resDxCLFC2,
  "~ dex + cell" = resDxCLFC3,
  "~ dex + cell" = resDxCLFC4
)

plotMA_arrange_iterative(res_list)
```



# FDR & qvalue 
```{r}

plotStats <- function(res_list) {
  for (i in seq_along(res_list)) {
    result <- res_list[[i]]
    res_name <- names(res_list)[i]
    qobjs <- qvalue(result$pvalue)
    hist <- hist(qobjs)
    titled <- hist + labs(title = paste(res_name, "|", sub(".*: ", "", result@elementMetadata@listData[["description"]][2])))
    print(titled)
    plot(qobjs)
    summary(qobjs)
  }
}


plotStats(res_list)

```

# Transformations & Variance
```{r}
# Contrast Dex
logDex <- log2(assay(ddsDex))

logDexplot <- meanSdPlot(logDex)

logDexplot[["gg"]] + labs(title = "~ dex: log2")

# Improved Transformations
vsdDex <- vst(ddsDex, blind = FALSE)

rldDex <- rlog(ddsDex, blind = FALSE)

ntdDex <- normTransform(ddsDex)

# Contrast Cell
logCell <- log2(assay(ddsCell))

logCellplot <- meanSdPlot(logCell)

logCellplot[["gg"]] + labs(title = "~ cell: log2")

# Improved Transformations
vsdCell <- vst(ddsCell, blind = FALSE)

rldCell <- rlog(ddsCell, blind = FALSE)

ntdCell <- normTransform(ddsCell)

# Contrast Dex + Cell
logDxC <- log2(assay(ddsDxC))

logDxCplot <- meanSdPlot(logDxC)

logDxCplot[["gg"]] + labs(title = "~ dex + cell: log2")


# Improved Transformations
vsdDxC <- vst(ddsDxC, blind = FALSE)

rldDxC <- rlog(ddsDxC, blind = FALSE)

ntdDxC <- normTransform(ddsDxC)



trans_list <- list(
  "~ dex: vst" = vsdDex,
  "~ dex: rlog" = rldDex,
  "~ dex: norm" = ntdDex,
  "~ cell: vst" = vsdCell,
  "~ cell: rlog" = rldCell,
  "~ cell: norm" = ntdCell,
  "~ dex + cell: vst" = vsdDxC,
  "~ dex + cell: rlog" = rldDxC,
  "~ dex + cell: norm" = ntdDxC
)


plot_Transformations <- function(trans_list) {
  plots <- list()
  for (i in seq_along(trans_list)) {
    trans <- trans_list[[i]]
    name <- names(trans_list)[i]
    sd <- meanSdPlot(assay(trans), plot  = FALSE)
    plots[[i]] <- sd[["gg"]] + labs(title = name) + theme(legend.position = "none", 
                                                          axis.title.x = element_blank(),
                                                          axis.title.y = element_blank(),
                                                          axis.text.x = element_blank(),
                                                          axis.text.y = element_blank(),
                                                          axis.ticks = element_blank())
  }
  grid.arrange(grobs = plots, ncol = 4)
}


plot_Transformations(trans_list)

```

# Quality Assesment

## Quality assesment with Heatmaps
```{r}
# Select top 20 DEG's
selectDex <- order(rowMeans(counts(ddsDex, normalized = TRUE)), decreasing = TRUE)[1:20]

selectCell <- order(rowMeans(counts(ddsCell, normalized = TRUE)), decreasing = TRUE)[1:20]

selectDxC <- order(rowMeans(counts(ddsDxC, normalized = TRUE)), decreasing = TRUE)[1:20]

# Extract clustering variables
dfDex <- as.data.frame(colData(ddsDex)[, c("dex")])

dfCell <- as.data.frame(colData(ddsCell)[, c("cell")])

dfDxC <- as.data.frame(colData(ddsDxC)[, c("dex", "cell")])


# Heatmaps
pheatmap(assay(ntdDxC)[selectDxC, ],
  cluster_rows = TRUE, show_rownames = FALSE,
  cluster_cols = TRUE, annotation_col = dfDxC, show_colnames = FALSE,
  main = "ntd", scale = "row"
)

pheatmap(assay(vsdDxC)[selectDxC, ],
  cluster_rows = TRUE, show_rownames = FALSE,
  cluster_cols = TRUE, annotation_col = dfDxC, show_colnames = FALSE,
  main = "vsd", scale = "row"
)

pheatmap(assay(rldDxC)[selectDxC, ],
  cluster_rows = TRUE, show_rownames = FALSE,
  cluster_cols = TRUE, annotation_col = dfDxC, show_colnames = FALSE,
  main = "rld", scale = "row"
)
```

## Sample distance
```{r}
# Determine between group variety
sampleDists <- dist(t(assay(vsdDxC)))

sampleDistMatrix <- as.matrix(sampleDists)

rownames(sampleDistMatrix) <- paste(vsdDxC$dex, vsdDxC$cell, sep = "-")

colnames(sampleDistMatrix) <- NULL

colors <- colorRampPalette(rev(brewer.pal(9, "Blues")))(255)

pheatmap(sampleDistMatrix,
  clustering_distance_rows = sampleDists,
  clustering_distance_cols = sampleDists,
  col = colors, main = "Between Group Variability"
)
```

## PCA plots
```{r}
plotPCA(vsdDxC, intgroup = c("dex", "cell")) + labs(title = "vst(~Dex+Cell): PCA by Dex & Cell")

plotPCA(vsdDxC, intgroup = c("cell")) + labs(title = "vst(~Dex+Cell): PCA by Cell")

plotPCA(vsdDxC, intgroup = c("dex")) + labs(title = "vst(~Dex+Cell): PCA by Dex")


pcaData <- plotPCA(vsdDxC,
  intgroup = c("dex", "cell"),
  returnData = TRUE
)

percentVar <- round(100 * attr(pcaData, "percentVar"))

ggplot(pcaData, aes(PC1, PC2, color = dex, shape = cell)) +
  geom_point(size = 3) +
  xlab(paste0("PC1: ", percentVar[1], "% variance")) +
  ylab(paste0("PC2: ", percentVar[2], "% variance")) +
  coord_fixed() +
  labs(title = "vst(~Dex+Cell): PCA by Dex & Cell")
```